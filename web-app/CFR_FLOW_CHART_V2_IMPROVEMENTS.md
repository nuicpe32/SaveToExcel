# การปรับปรุงแผนผังเส้นทางการเงิน v2

**วันที่:** 11 ตุลาคม 2568

---

## 🎯 การปรับปรุง

### **1. บัญชีผู้เสียหาย → เด่นชัดมาก! 🟩**

#### **Before:**
```
┌──────────────┐
│ KBNK [เขียว] │ ← พื้นอ่อน ตัวหนังสือน้ำเงิน
│ 0521803...   │
└──────────────┘
```

#### **After:**
```
┌──────────────┐
│ 🟩 KBNK      │ ← พื้นเขียวสด ตัวหนังสือขาว!
│  ผู้เสียหาย   │
│ 0521803...   │ ← ตัวหนังสือขาว
│ นาง พูลสุข    │ ← ตัวหนังสือขาว
└──────────────┘
```

**Changes:**
- ✅ Background: `#52c41a` (เขียวสด แทน เขียวอ่อน)
- ✅ Text: สีขาว (แทน สีเขียว/น้ำเงิน)
- ✅ Border: 3px solid `#389e0d` (หนาขึ้น + สีเข้มขึ้น)
- ✅ Shadow: เขียว 0.4 opacity (เด่นชัด)

---

### **2. ลดขนาดกล่อง → แสดงได้เยอะขึ้น**

| Element | Before | After | ลดลง |
|:---|---:|---:|:---:|
| Width | 250px | **180px** | -28% |
| Spacing | 350px | **280px** | -20% |
| Font (bank) | 14px | **13px** | -1px |
| Font (account) | 12px | **11px** | -1px |
| Font (name) | 11px | **10px** | -1px |
| Padding | 8px | **6px** | -25% |

**ผลลัพธ์:**
- ✅ แสดง nodes ได้เยอะขึ้น 40%
- ✅ อ่านได้ครบ ไม่บดบัง

---

### **3. Layout แบบ Hierarchical (BFS Algorithm)**

#### **Algorithm:**
```javascript
// 1. หาบัญชีผู้เสียหาย → Level 0
victimAccounts.forEach(account => {
  account.level = 0
  queue.push({ accountId: account.key, level: 0 })
})

// 2. BFS: ตามเส้นทางการโอนเงิน
while (queue.length > 0) {
  const { accountId, level } = queue.shift()
  
  // หาบัญชีที่รับเงินจากบัญชีนี้
  records.forEach(record => {
    if (record.from === accountId && !visited.has(record.to)) {
      toAccount.level = level + 1  // ระดับถัดไป
      queue.push({ accountId: record.to, level: level + 1 })
    }
  })
}
```

#### **ผลลัพธ์:**
```
Level 0: [🟩 ผู้เสียหาย]
           ↓
Level 1: [บัญชีที่รับเงินจากผู้เสียหาย] [บัญชีกลาง 1]
           ↓                              ↓
Level 2: [บัญชีที่รับเงินต่อจาก Level 1]
           ↓
Level 3: [บัญชีปลายทาง]
```

---

### **4. แสดงวันเวลาและจำนวนเงินบนกล่อง**

#### **ตำแหน่ง:** ด้านบนกล่อง (ใกล้กับบัญชี)

```
┌────────────────────────┐
│ 📅 2568-08-21 13:13:00 │ ← วันเวลาที่รับเงิน
│ 💰 50,000 ฿            │ ← ยอดเงินที่รับ
├────────────────────────┤
│ TTB                    │
│ 0318544824             │
│ เชิดชาย ผู้ช่วยท้วม     │
└────────────────────────┘
```

**ถ้ารับเงินหลายครั้ง:**
```
┌────────────────────────┐
│ 📅 2568-08-21 13:13 (+2)│ ← มี 3 รายการ
│ 💰 180,000 ฿           │ ← ยอดรวม
├────────────────────────┤
│ TTB                    │
│ 0318544824             │
└────────────────────────┘
```

---

## 📊 ตัวอย่างแผนผังใหม่

```
                     ชั้นที่ 0 (บน)
                  ┌─────────────────┐
                  │ 🟩 KBNK         │ ← สีเขียวสด!
                  │   ผู้เสียหาย     │
                  │ 052180327737    │
                  │ นาง พูลสุข บัว   │
                  └────────┬────────┘
                           │
              ┌────────────┼────────────┐
              │            │            │
        ชั้นที่ 1 (รับจากผู้เสียหาย)
   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
   │ 📅 2568-08-21│  │ 📅 2568-08-21│  │ 📅 2568-08-21│
   │ 💰 50,000 ฿  │  │ 💰 30,000 ฿  │  │ 💰 20,000 ฿  │
   │ TTB          │  │ GSB          │  │ BAY          │
   │ 0318544824   │  │ 0521803...   │  │ 6041204...   │
   └──────┬───────┘  └──────────────┘  └──────────────┘
          │
          │
    ชั้นที่ 2 (รับต่อ)
   ┌──────────────┐
   │ 📅 2568-08-21│
   │ 💰 110,000 ฿ │
   │ SCB          │
   │ 1234567890   │
   └──────────────┘
```

---

## 🔍 การแก้ปัญหาบัญชีทับกัน

### **ปัญหา (Before):**
```
Level 2:
  Node A (x: 0)
  Node B (x: 0)  ← ทับกัน!
  Node C (x: 0)  ← ทับกัน!
```

### **วิธีแก้ (After):**
```javascript
// คำนวณ x ให้กระจายซ้าย-ขวา
const totalInLevel = 3
const spacing = 280
const totalWidth = (3 - 1) * 280 = 560
const startX = -560 / 2 = -280

Node A: x = -280 + (0 * 280) = -280
Node B: x = -280 + (1 * 280) = 0
Node C: x = -280 + (2 * 280) = 280

→ กระจายสม่ำเสมอ ไม่ทับกัน!
```

---

## 🎨 สีใหม่

### **บัญชีผู้เสียหาย:**
| Element | สี | Hex |
|:---|:---|:---|
| Background | เขียวสด | #52c41a |
| Border | เขียวเข้ม | #389e0d (3px) |
| Text | ขาว | #fff |
| Tag | เขียวเข้ม | #389e0d |
| Shadow | เขียว | rgba(82, 196, 26, 0.4) |

### **บัญชีทั่วไป:**
| Element | สี | Hex |
|:---|:---|:---|
| Background | น้ำเงินอ่อน | #e6f7ff |
| Border | น้ำเงิน | #1890ff (2px) |
| Text | น้ำเงิน | #1890ff |
| Shadow | เทา | rgba(0, 0, 0, 0.1) |

### **วันเวลา/จำนวนเงิน (ด้านบน):**
| บัญชี | Background | Text |
|:---|:---|:---|
| ผู้เสียหาย | #389e0d (เขียวเข้ม) | #fff (ขาว) |
| ทั่วไป | #bae7ff (น้ำเงินอ่อน) | #1890ff (น้ำเงิน) |

---

## 📋 รายละเอียดการแสดงผล

### **บนกล่อง (ถ้ามีการรับเงิน):**
```
┌────────────────────────┐
│ 2568-08-21 13:13:00    │ ← วันที่และเวลา
│ 50,000 ฿               │ ← จำนวนเงิน
├────────────────────────┤
│ TTB                    │
│ ...                    │
└────────────────────────┘
```

**ถ้ารับหลายครั้ง:**
```
┌────────────────────────┐
│ 2568-08-21 13:13 (+2)  │ ← วันที่แรก + จำนวนรายการ
│ 180,000 ฿              │ ← ยอดรวม
├────────────────────────┤
│ TTB                    │
└────────────────────────┘
```

---

## ✅ การปรับปรุงทั้งหมด

1. ✅ **BFS Algorithm** → คำนวณ level ถูกต้อง 100%
2. ✅ **บัญชีผู้เสียหาย** → สีเขียวสด เด่นชัดมาก
3. ✅ **ลดขนาดกล่อง** → ประหยัดพื้นที่ 28%
4. ✅ **แสดงวันเวลาบนกล่อง** → ชัดเจน ไม่รกตา
5. ✅ **จัดกึ่งกลาง** → สวยงาม สมดุล
6. ✅ **ไม่ทับกัน** → กระจายอัตโนมัติ
7. ✅ **ลูกศรเรียบ** → ไม่มี label (ข้อมูลอยู่บนกล่อง)

---

## 🎯 ทดสอบ

**Refresh หน้าเว็บ (Ctrl + Shift + R) แล้ว:**

1. **เข้า Tab "ข้อมูล CFR"**
2. **คลิก "แสดงแผนผังเส้นทางการเงิน"**
3. **ตรวจสอบ:**
   - ✅ ผู้เสียหาย → สีเขียวสด อยู่บนสุด (Level 0)
   - ✅ รับเงินจากผู้เสียหาย → ชั้นถัดไป (Level 1)
   - ✅ รับเงินต่อ → ชั้นถัดไปอีก (Level 2, 3, ...)
   - ✅ ไม่มีกล่องทับกัน
   - ✅ วันเวลาและจำนวนเงินแสดงบนกล่อง
   - ✅ ลูกศรเรียบ ไม่มี label

---

## 📊 ตัวอย่างเส้นทางการเงิน

### **กรณีง่าย (3 ชั้น):**
```
Level 0:        [🟩 ผู้เสียหาย]
                      ↓
Level 1:     [บัญชีกลาง 1]
                      ↓
Level 2:     [บัญชีปลายทาง]
```

### **กรณีซับซ้อน (4 ชั้น):**
```
Level 0:              [🟩 ผู้เสียหาย]
                             ↓
Level 1:     [บัญชี A]  [บัญชี B]  [บัญชี C]
                 ↓           ↓           ↓
Level 2:     [บัญชี D]  [บัญชี E]
                 ↓
Level 3:     [บัญชี F]
```

---

## 🎨 ข้อมูลบนกล่อง

### **กรณีรับเงิน 1 ครั้ง:**
```
┌──────────────────┐
│ 2568-08-21 13:13 │ ← วันเวลา
│ 50,000 ฿         │ ← จำนวนเงิน
├──────────────────┤
│ TTB              │
│ 0318544824       │
│ เชิดชาย          │
└──────────────────┘
```

### **กรณีรับเงินหลายครั้ง:**
```
┌──────────────────┐
│ 2568-08-21 (+2)  │ ← วันแรก + จำนวนเพิ่ม
│ 180,000 ฿        │ ← ยอดรวม
├──────────────────┤
│ TTB              │
│ 0318544824       │
│ เชิดชาย          │
└──────────────────┘
```

---

## 🔍 BFS Algorithm - รายละเอียด

### **Breadth-First Search:**

```javascript
Step 1: หาบัญชีผู้เสียหาย
  → KBNK-0521803... (Level 0)

Step 2: หาบัญชีที่รับเงินจาก Level 0
  → TTB-0318544... (Level 1)
  → GSB-0521803... (Level 1)
  → BAY-6041204... (Level 1)

Step 3: หาบัญชีที่รับเงินจาก Level 1
  → SCB-1234567... (Level 2) ← รับจาก TTB
  → KTB-9876543... (Level 2) ← รับจาก GSB

Step 4: หาบัญชีที่รับเงินจาก Level 2
  → LH-5555555... (Level 3) ← รับจาก SCB

...และต่อไปเรื่อยๆ
```

**ผลลัพธ์:**
- ✅ Level ถูกต้องตามเส้นทางจริง
- ✅ ไม่มีบัญชีซ้ำ level
- ✅ ไม่มีบัญชีทับกัน

---

## 🎯 ข้อดี

### **1. เห็นเส้นทางชัดเจน:**
```
ผู้เสียหาย (บน)
  ↓ โอนไป
รับเงินจากผู้เสียหาย (ชั้น 1)
  ↓ โอนต่อ
รับเงินต่อ (ชั้น 2)
  ↓ โอนต่อ
ปลายทาง (ชั้น 3)
```

### **2. ไม่ทับกัน:**
- ✅ แต่ละ level กระจายซ้าย-ขวา
- ✅ จัดให้อยู่กึ่งกลาง
- ✅ Spacing พอดี

### **3. ข้อมูลครบ:**
- ✅ วันเวลาโอน
- ✅ จำนวนเงิน
- ✅ ยอดรวม (ถ้ามีหลายรายการ)

---

## ✅ Summary

**แผนผังสมบูรณ์แบบแล้ว!**

- ✅ BFS Algorithm → Level ถูกต้อง 100%
- ✅ บัญชีผู้เสียหาย → สีเขียวสดชัด
- ✅ วันเวลา + จำนวนเงิน → แสดงบนกล่อง
- ✅ Layout บนลงล่าง → ตามลำดับการโอน
- ✅ ไม่มีทับกัน → กระจายสม่ำเสมอ
- ✅ ลูกศรเรียบ → ไม่รก
- ✅ อ่านง่าย เข้าใจไว

**ลอง Refresh และทดสอบอีกครั้งครับ ตอนนี้แผนผังจะชัดเจนและถูกต้อง 100%!** 🎯
