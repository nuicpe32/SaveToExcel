# ฟีเจอร์ตรวจจับบัญชีที่ส่งหมายเรียกแล้วใน CFR

**วันที่:** 11 ตุลาคม 2568

---

## 🎯 ภาพรวม

ตรวจสอบและแสดง Tag "ส่งหมายเรียกแล้ว" ในตาราง CFR เมื่อพบบัญชีที่มีอยู่ในรายการหมายเรียกบัญชีธนาคารของคดีนั้นๆ แล้ว

---

## 🔍 Logic การตรวจสอบ

### **ขั้นตอน:**

1. **เปรียบเทียบเลขบัญชี** ใน CFR กับ รายการหมายเรียกบัญชีธนาคาร
2. **ลบช่องว่างและ `-` ออก** ก่อนเปรียบเทียบ
3. **ถ้าตรงกัน** → แสดง Tag "ส่งหมายเรียกแล้ว"

---

## 🎨 การแสดงผล

### **กรณีที่ 1: บัญชีมีในรายการหมายเรียก (ได้รับข้อมูลแล้ว)**

```
┌────────────────────────────────────┐
│ KBNK [ส่งหมายเรียกแล้ว]            │ ← Tag สีม่วง
│ 052180327737                      │
│ อำพร โปร่งใจ                       │
│ ✓ ได้รับข้อมูลแล้ว                 │ ← ข้อความสีม่วง
└────────────────────────────────────┘
```

---

### **กรณีที่ 2: บัญชีมีในรายการหมายเรียก (ยังไม่ตอบกลับ)**

```
┌────────────────────────────────────┐
│ TTB [ส่งหมายเรียกแล้ว]             │ ← Tag สีม่วง
│ 0318544824                        │
│ เชิดชาย ผู้ช่วยท้วม                │
│ ✗ ยังไม่ตอบกลับ (ส่งไปแล้ว 15 วัน)│ ← ข้อความสีม่วง
└────────────────────────────────────┘
```

---

### **กรณีที่ 3: บัญชีผู้เสียหาย + ส่งหมายเรียกแล้ว**

```
┌────────────────────────────────────┐
│ GSB [ผู้เสียหาย] [ส่งหมายเรียกแล้ว]│ ← 2 Tags
│ 052180327737                      │
│ นาง พูลสุข บัววิรัตน์เลิศ          │
│ ✓ ได้รับข้อมูลแล้ว                 │
└────────────────────────────────────┘
```

---

## 💻 Code Implementation

### **ฟังก์ชันตรวจสอบ:**

```javascript
const findBankAccountSummons = (accountNo: string) => {
  if (!accountNo || !bankAccounts) return null
  
  // ลบช่องว่างและ - ออก
  const cleanAccountNo = accountNo.replace(/[\s-]/g, '')
  
  // หาในรายการหมายเรียกบัญชีธนาคาร
  return bankAccounts.find(ba => {
    if (!ba.account_number) return false
    const cleanBankAccount = ba.account_number.replace(/[\s-]/g, '')
    return cleanBankAccount === cleanAccountNo
  })
}
```

---

### **การแสดง Tag:**

```jsx
{summons && (
  <Tag color="purple" style={{ marginLeft: 4, fontSize: '10px' }}>
    ส่งหมายเรียกแล้ว
  </Tag>
)}
```

---

### **การแสดงสถานะ:**

```jsx
{summons && (
  <div style={{ fontSize: '10px', color: '#722ed1', marginTop: 2 }}>
    {summons.reply_status 
      ? '✓ ได้รับข้อมูลแล้ว' 
      : `✗ ยังไม่ตอบกลับ (ส่งไปแล้ว ${calculateDaysSinceSent(summons.document_date)})`
    }
  </div>
)}
```

---

## 📊 ตัวอย่างตาราง CFR

```
Bank Case ID: 25680923KBNK00407 (5 รายการ)

┌─────────────────────┬─────────────────────┬────────────┬──────────┐
│ บัญชีต้นทาง        │ บัญชีปลายทาง        │ วันเวลาโอน │ ยอดเงิน  │
├─────────────────────┼─────────────────────┼────────────┼──────────┤
│ KBNK [ผู้เสียหาย]   │ TTB [ส่งหมายแล้ว]   │ 2568-08-21 │ 50,000 ฿│
│ [ส่งหมายแล้ว]       │ 0318544824          │ 13:13      │          │
│ 052180327737       │ เชิดชาย ผู้ช่วยท้วม  │            │          │
│ นาง พูลสุข บัว      │ ✗ ยังไม่ตอบ (10 วัน) │            │          │
│ ✓ ได้รับข้อมูลแล้ว  │                     │            │          │
├─────────────────────┼─────────────────────┼────────────┼──────────┤
│ TTB [ส่งหมายแล้ว]   │ BAY                 │ 2568-08-21 │110,000 ฿│
│ 0318544824         │ 6041204414          │ 13:27      │          │
│ เชิดชาย ผู้ช่วยท้วม │ นาง สมหญิง ดี       │            │          │
│ ✗ ยังไม่ตอบ (10 วัน)│                     │            │          │
└─────────────────────┴─────────────────────┴────────────┴──────────┘
```

---

## 🏷️ Tag และสถานะ

### **Tag "ส่งหมายเรียกแล้ว":**
- **สี:** สีม่วง (`color="purple"`)
- **ขนาด:** เล็ก (`fontSize: '10px'`)
- **ตำแหน่ง:** ข้างธนาคาร

### **สถานะด้านล่าง:**
- **สี:** สีม่วง (#722ed1)
- **ขนาด:** 10px
- **รูปแบบ:**
  - ✓ ได้รับข้อมูลแล้ว (reply_status = true)
  - ✗ ยังไม่ตอบกลับ (ส่งไปแล้ว X วัน) (reply_status = false)

---

## 🎯 Use Cases

### **1. ติดตามสถานะหมายเรียก**
```
เห็นได้ทันทีว่าบัญชีไหนส่งหมายเรียกไปแล้ว
และธนาคารตอบกลับหรือยัง
```

### **2. วิเคราะห์เส้นทางการเงิน**
```
บัญชีผู้เสียหาย [ส่งหมายแล้ว] 
  → โอนไป → บัญชีกลาง [ส่งหมายแล้ว]
  → โอนไป → บัญชีผู้ต้องหา
```

### **3. ตรวจสอบความครอบคลุมการส่งหมาย**
```
- บัญชีใน CFR: 10 บัญชี
- ส่งหมายเรียกแล้ว: 7 บัญชี
- ยังไม่ส่ง: 3 บัญชี ← ต้องส่งเพิ่ม
```

---

## 🔄 การทำงาน

### **1. โหลดข้อมูลบัญชีธนาคาร:**
```javascript
fetchCaseDetails(record.id)
  → เรียก API: /criminal-cases/{id}/bank-accounts
  → เก็บใน state: bankAccounts
```

### **2. โหลดข้อมูล CFR:**
```javascript
fetchCfrRecords(caseId)
  → เรียก API: /cfr/{id}/records
  → เก็บใน state: cfrRecords
```

### **3. ตรวจสอบแต่ละ record:**
```javascript
// สำหรับแต่ละ row ในตาราง CFR
const summons = findBankAccountSummons(record.from_account_no)
  → ค้นหาใน bankAccounts
  → ถ้าเจอ → แสดง Tag + สถานะ
```

---

## 📋 ตัวอย่างข้อมูล

### **รายการหมายเรียกบัญชีธนาคาร:**
```javascript
bankAccounts = [
  { 
    account_number: "052180327737",
    bank_name: "กสิกรไทย",
    reply_status: true,
    document_date: "2024-09-25"
  },
  { 
    account_number: "0318544824",
    bank_name: "ทหารไทยธนชาต",
    reply_status: false,
    document_date: "2024-10-01"
  }
]
```

### **CFR Records:**
```javascript
cfrRecords = [
  {
    from_account_no: "052180327737",  // ← มีในรายการหมายเรียก!
    to_account_no: "0318544824"       // ← มีในรายการหมายเรียก!
  }
]
```

### **ผลลัพธ์:**
- ✅ บัญชีต้นทาง: แสดง Tag "ส่งหมายเรียกแล้ว" + "✓ ได้รับข้อมูลแล้ว"
- ✅ บัญชีปลายทาง: แสดง Tag "ส่งหมายเรียกแล้ว" + "✗ ยังไม่ตอบกลับ (ส่งไปแล้ว 10 วัน)"

---

## 🎨 สี Theme

| Element | สี | Hex Code | ใช้กับ |
|:---|:---|:---|:---|
| Tag "ผู้เสียหาย" | เขียว | green | ผู้เสียหายในคดี |
| Tag "ส่งหมายเรียกแล้ว" | ม่วง | purple | บัญชีที่ส่งหมายแล้ว |
| ข้อความสถานะ | ม่วงเข้ม | #722ed1 | สถานะการตอบกลับ |
| ✓ ได้รับข้อมูล | ม่วง | #722ed1 | reply_status = true |
| ✗ ยังไม่ตอบกลับ | ม่วง | #722ed1 | reply_status = false |

---

## 🧪 การทดสอบ

### **Test Case 1: บัญชีมีในรายการหมายเรียก (ตอบกลับแล้ว)**

**ข้อมูล:**
- CFR: บัญชี `052180327737`
- รายการหมายเรียก: มีบัญชี `052180327737` (reply_status = true)

**ผลลัพธ์:**
```
KBNK [ส่งหมายเรียกแล้ว]
052180327737
อำพร โปร่งใจ
✓ ได้รับข้อมูลแล้ว
```

---

### **Test Case 2: บัญชีมีในรายการหมายเรียก (ยังไม่ตอบ)**

**ข้อมูล:**
- CFR: บัญชี `0318544824`
- รายการหมายเรียก: มีบัญชี `0318544824` (reply_status = false, ส่งไป 10 วัน)

**ผลลัพธ์:**
```
TTB [ส่งหมายเรียกแล้ว]
0318544824
เชิดชาย ผู้ช่วยท้วม
✗ ยังไม่ตอบกลับ (ส่งไปแล้ว 10 วัน)
```

---

### **Test Case 3: บัญชีไม่มีในรายการหมายเรียก**

**ข้อมูล:**
- CFR: บัญชี `1234567890`
- รายการหมายเรียก: ไม่มีบัญชีนี้

**ผลลัพธ์:**
```
BAY
1234567890
นาย สมชาย ใจดี
(ไม่มี Tag, ไม่มีสถานะ)
```

---

### **Test Case 4: บัญชีผู้เสียหาย + ส่งหมายเรียกแล้ว**

**ข้อมูล:**
- CFR: บัญชี `052180327737` (ชื่อ "นาง พูลสุข บัววิรัตน์เลิศ")
- ผู้เสียหายในคดี: "นาง พูลสุข บัววิรัตน์เลิศ"
- รายการหมายเรียก: มีบัญชีนี้ (reply_status = true)

**ผลลัพธ์:**
```
KBNK [ผู้เสียหาย] [ส่งหมายเรียกแล้ว]
052180327737
นาง พูลสุข บัววิรัตน์เลิศ
✓ ได้รับข้อมูลแล้ว
```

---

## 📊 รูปแบบการตรวจสอบเลขบัญชี

### **ลบ special characters ก่อนเปรียบเทียบ:**

| รูปแบบใน CFR | รูปแบบในหมายเรียก | ผลการเปรียบเทียบ |
|:---|:---|:---:|
| `052180327737` | `052180327737` | ✅ ตรง |
| `052180327737` | `052-180-327-737` | ✅ ตรง (ลบ `-` ออก) |
| `052180327737` | `052 180 327 737` | ✅ ตรง (ลบช่องว่าง) |
| `0521 8032 7737` | `052180327737` | ✅ ตรง (ลบช่องว่าง) |

---

## 🎯 ประโยชน์

### **1. ติดตามสถานะหมายเรียก:**
- เห็นได้ทันทีว่าบัญชีไหนส่งหมายไปแล้ว
- ธนาคารตอบกลับหรือยัง
- ส่งไปนานแค่ไหนแล้ว

### **2. วางแผนส่งหมายเพิ่ม:**
- บัญชีไหนยังไม่ส่ง → ต้องส่ง
- บัญชีไหนส่งแล้วแต่ยังไม่ตอบ → ติดตาม

### **3. วิเคราะห์เส้นทางการเงิน:**
- มองเห็นภาพรวมว่าบัญชีไหนสำคัญ
- บัญชีไหนต้องขอข้อมูลเพิ่ม

---

## 📁 ไฟล์ที่แก้ไข

### **Frontend:**
- `web-app/frontend/src/pages/DashboardPage.tsx`
  - เพิ่มฟังก์ชัน `findBankAccountSummons(accountNo)`
  - แก้ render function คอลัมน์ "บัญชีต้นทาง"
  - แก้ render function คอลัมน์ "บัญชีปลายทาง"
  - เพิ่ม Tag "ส่งหมายเรียกแล้ว" (สีม่วง)
  - เพิ่มแสดงสถานะการตอบกลับ

---

## ✅ สรุป

**ฟีเจอร์ตรวจจับหมายเรียกพร้อมแล้ว!**

- ✅ ตรวจสอบเลขบัญชีกับรายการหมายเรียก
- ✅ แสดง Tag "ส่งหมายเรียกแล้ว" สีม่วง
- ✅ แสดงสถานะการตอบกลับ
- ✅ แสดงจำนวนวันที่ส่งไป
- ✅ รองรับ Tag ซ้อน (ผู้เสียหาย + ส่งหมายแล้ว)

**ระบบ CFR ครบฟีเจอร์ทั้งหมดแล้ว!** 🎉

---

## 🎯 ฟีเจอร์ CFR ทั้งหมด

1. ✅ อัพโหลดไฟล์ .xlsx
2. ✅ แสดงตาราง 1 ตารางต่อ 1 bank_case_id
3. ✅ เรียงลำดับตามวันเวลาที่โอน
4. ✅ ตรวจจับผู้เสียหาย (Tag เขียว)
5. ✅ ตรวจจับหมายเรียก (Tag ม่วง)
6. ✅ แสดงสถานะการตอบกลับ
7. ✅ คลิกดูรายละเอียดบัญชีปลายทาง
8. ✅ รักษาเลข 0 หน้า

**พร้อมใช้งานจริงแล้ว!** 🚀

---

**หมายเหตุ:** ยังไม่ได้ commit ขึ้น Git ตามคำสั่ง

