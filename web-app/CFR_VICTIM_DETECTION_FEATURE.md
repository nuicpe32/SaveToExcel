# ฟีเจอร์ตรวจจับบัญชีผู้เสียหายใน CFR

**วันที่:** 11 ตุลาคม 2568

---

## 🎯 ภาพรวม

เพิ่มการตรวจสอบและแสดง Tag "ผู้เสียหาย" ในตาราง CFR เมื่อพบบัญชีที่ตรงกับชื่อผู้เสียหายในคดี

---

## 🔍 Logic การตรวจสอบ

### **ขั้นตอนการตรวจสอบ:**

1. **ลบคำนำหน้า** (นาย, นาง, นางสาว, น.ส., Mr., Mrs., Miss, Ms.)
2. **เปรียบเทียบแบบต่างๆ** (6 วิธี):

| # | วิธีการตรวจสอบ | ตัวอย่าง |
|:---:|:---|:---|
| 1 | **ตรงกันทุกตัวอักษร** | "พูลสุข บัววิรัตน์เลิศ" = "พูลสุข บัววิรัตน์เลิศ" |
| 2 | **ไม่สนใจตัวพิมพ์** | "poolsuk" = "POOLSUK" |
| 3 | **ไม่สนใจช่องว่าง** | "พูลสุข บัววิรัตน์เลิศ" = "พูลสุขบัววิรัตน์เลิศ" |
| 4 | **ผู้เสียหายเป็นส่วนหนึ่งของชื่อบัญชี** | ชื่อบัญชี: "นาง พูลสุข บัววิรัตน์เลิศ และคณะ" |
| 5 | **ชื่อบัญชีเป็นส่วนหนึ่งของผู้เสียหาย** | ผู้เสียหาย: "นาง พูลสุข บัววิรัตน์เลิศ และผู้อื่น" |
| 6 | **Fuzzy Match** | คำแรก + คำสุดท้ายตรงกัน: "พูลสุข xxx บัววิรัตน์เลิศ" |

---

## 🎨 การแสดงผล

### **บัญชีต้นทาง:**
```
┌──────────────────────────┐
│ KBANK [ผู้เสียหาย]       │  ← Tag สีเขียว
│ 1234567890              │
│ นาง พูลสุข บัววิรัตน์เลิศ │
└──────────────────────────┘
```

### **บัญชีปลายทาง:**
```
┌──────────────────────────┐
│ TTB [ผู้เสียหาย] [คลิก]  │  ← Tag สีเขียว + คลิกดูรายละเอียด
│ 9876543210              │
│ นาง พูลสุข บัววิรัตน์เลิศ │
└──────────────────────────┘
```

---

## 📊 ตัวอย่างการทำงาน

### **กรณีที่ 1: ชื่อตรงทุกประการ**

| ผู้เสียหายในคดี | ชื่อบัญชี | ผลลัพธ์ |
|:---|:---|:---:|
| นาง พูลสุข บัววิรัตน์เลิศ | นาง พูลสุข บัววิรัตน์เลิศ | ✅ ผู้เสียหาย |
| นาง พูลสุข บัววิรัตน์เลิศ | พูลสุข บัววิรัตน์เลิศ | ✅ ผู้เสียหาย |

---

### **กรณีที่ 2: มีคำนำหน้าต่างกัน**

| ผู้เสียหายในคดี | ชื่อบัญชี | ผลลัพธ์ |
|:---|:---|:---:|
| พูลสุข บัววิรัตน์เลิศ | นาง พูลสุข บัววิรัตน์เลิศ | ✅ ผู้เสียหาย |
| นาง พูลสุข บัววิรัตน์เลิศ | น.ส. พูลสุข บัววิรัตน์เลิศ | ✅ ผู้เสียหาย |
| Mr. John Smith | นาย John Smith | ✅ ผู้เสียหาย |

---

### **กรณีที่ 3: ชื่อบัญชีมีข้อความเพิ่มเติม**

| ผู้เสียหายในคดี | ชื่อบัญชี | ผลลัพธ์ |
|:---|:---|:---:|
| พูลสุข บัววิรัตน์เลิศ | นาง พูลสุข บัววิรัตน์เลิศ และคณะ | ✅ ผู้เสียหาย |
| พูลสุข บัววิรัตน์เลิศ | บริษัท พูลสุข บัววิรัตน์เลิศ จำกัด | ✅ ผู้เสียหาย |

---

### **กรณีที่ 4: ช่องว่างต่างกัน**

| ผู้เสียหายในคดี | ชื่อบัญชี | ผลลัพธ์ |
|:---|:---|:---:|
| พูลสุข บัววิรัตน์เลิศ | พูลสุข  บัววิรัตน์เลิศ | ✅ ผู้เสียหาย |
| พูลสุข บัววิรัตน์เลิศ | พูลสุขบัววิรัตน์เลิศ | ✅ ผู้เสียหาย |

---

### **กรณีที่ 5: ตัวพิมพ์ต่างกัน (ภาษาอังกฤษ)**

| ผู้เสียหายในคดี | ชื่อบัญชี | ผลลัพธ์ |
|:---|:---|:---:|
| John Smith | JOHN SMITH | ✅ ผู้เสียหาย |
| john smith | John Smith | ✅ ผู้เสียหาย |

---

### **กรณีที่ 6: Fuzzy Match (คำแรก + คำสุดท้าย)**

| ผู้เสียหายในคดี | ชื่อบัญชี | ผลลัพธ์ |
|:---|:---|:---:|
| พูลสุข บัววิรัตน์เลิศ | นาง พูลสุข xxx บัววิรัตน์เลิศ | ✅ ผู้เสียหาย |
| สมชาย ใจดี | นาย สมชาย xxx yyy ใจดี | ✅ ผู้เสียหาย |

---

## 💻 Code Implementation

### **ฟังก์ชันตรวจสอบ:**

```javascript
const isVictimAccount = (accountName: string): boolean => {
  if (!accountName || !selected?.complainant) return false
  
  const complainant = selected.complainant.trim()
  const account = accountName.trim()
  
  // ลบคำนำหน้า
  const removeTitle = (name: string): string => {
    return name
      .replace(/^(นาย|นาง|นางสาว|น\.ส\.|Mr\.|Mrs\.|Miss|Ms\.)\s*/gi, '')
      .trim()
  }
  
  const cleanComplainant = removeTitle(complainant)
  const cleanAccount = removeTitle(account)
  
  // 6 วิธีการตรวจสอบ
  // 1. ตรงกันทุกตัว
  if (cleanAccount === cleanComplainant) return true
  
  // 2. ไม่สนใจตัวพิมพ์
  if (cleanAccount.toLowerCase() === cleanComplainant.toLowerCase()) return true
  
  // 3. ไม่สนใจช่องว่าง
  if (cleanAccount.replace(/\s+/g, '') === cleanComplainant.replace(/\s+/g, '')) return true
  
  // 4-5. Contains
  if (cleanAccount.includes(cleanComplainant)) return true
  if (cleanComplainant.includes(cleanAccount)) return true
  
  // 6. Fuzzy match (คำแรก + คำสุดท้าย)
  const complainantWords = cleanComplainant.split(/\s+/).filter(w => w.length > 0)
  const accountWords = cleanAccount.split(/\s+/).filter(w => w.length > 0)
  
  if (complainantWords.length >= 2 && accountWords.length >= 2) {
    const firstMatch = complainantWords[0] === accountWords[0]
    const lastMatch = complainantWords[complainantWords.length - 1] === accountWords[accountWords.length - 1]
    if (firstMatch && lastMatch) return true
  }
  
  return false
}
```

---

## 🎨 UI Design

### **Tag "ผู้เสียหาย":**
```jsx
{isVictim && (
  <Tag color="green" style={{ marginLeft: 4, fontSize: '10px' }}>
    ผู้เสียหาย
  </Tag>
)}
```

**Style:**
- ✅ สีเขียว (`color="green"`)
- ✅ ตัวเล็ก (`fontSize: '10px'`)
- ✅ ห่างจากธนาคาร 4px (`marginLeft: 4`)

---

## 📋 ตัวอย่างตาราง

```
Bank Case ID: 25680923KBNK00407 (5 รายการ)

┌─────────────────────┬─────────────────────┬───────────────┬──────────────┐
│ บัญชีต้นทาง        │ บัญชีปลายทาง        │ วันเวลาที่โอน │ ยอดเงินที่โอน│
├─────────────────────┼─────────────────────┼───────────────┼──────────────┤
│ KBANK [ผู้เสียหาย]  │ TTB                 │ 2568-08-21    │  50,000.00 ฿│
│ 1234567890         │ 9876543210 [คลิก]   │ 13:13:00      │              │
│ นาง พูลสุข บัววิรัตน์│ นาย สมชาย ใจดี      │               │              │
├─────────────────────┼─────────────────────┼───────────────┼──────────────┤
│ TTB                │ BAY [ผู้เสียหาย]     │ 2568-08-21    │ 110,000.00 ฿│
│ 9876543210         │ 5555555555 [คลิก]   │ 13:27:48      │              │
│ นาย สมชาย ใจดี     │ พูลสุข บัววิรัตน์เลิศ│               │              │
└─────────────────────┴─────────────────────┴───────────────┴──────────────┘
```

---

## ✅ Features

### **1. ตรวจสอบทั้งบัญชีต้นทางและปลายทาง:**
- ✅ ตรวจสอบ `from_account_name`
- ✅ ตรวจสอบ `to_account_name`

### **2. ลบคำนำหน้าอัตโนมัติ:**
- ✅ นาย, นาง, นางสาว, น.ส.
- ✅ Mr., Mrs., Miss, Ms.

### **3. ตรวจสอบแบบ Flexible:**
- ✅ ไม่สนใจตัวพิมพ์ใหญ่/เล็ก
- ✅ ไม่สนใจช่องว่าง
- ✅ รองรับชื่อที่มีข้อความเพิ่มเติม
- ✅ Fuzzy match (คำแรก + คำสุดท้าย)

### **4. Tag สวยงาม:**
- ✅ สีเขียว
- ✅ ตัวเล็ก (10px)
- ✅ ไม่รบกวนข้อมูล

---

## 🧪 การทดสอบ

### **Test Case 1: ชื่อตรงกัน**

**ข้อมูล:**
- ผู้เสียหาย: "นาง พูลสุข บัววิรัตน์เลิศ"
- ชื่อบัญชี: "นาง พูลสุข บัววิรัตน์เลิศ"

**ผลลัพธ์:**
- ✅ แสดง Tag "ผู้เสียหาย"

---

### **Test Case 2: คำนำหน้าต่างกัน**

**ข้อมูล:**
- ผู้เสียหาย: "พูลสุข บัววิรัตน์เลิศ" (ไม่มีคำนำหน้า)
- ชื่อบัญชี: "นาง พูลสุข บัววิรัตน์เลิศ"

**ผลลัพธ์:**
- ✅ แสดง Tag "ผู้เสียหาย"

---

### **Test Case 3: ชื่อบัญชีมีข้อความเพิ่ม**

**ข้อมูล:**
- ผู้เสียหาย: "พูลสุข บัววิรัตน์เลิศ"
- ชื่อบัญชี: "บริษัท พูลสุข บัววิรัตน์เลิศ จำกัด"

**ผลลัพธ์:**
- ✅ แสดง Tag "ผู้เสียหาย"

---

### **Test Case 4: Fuzzy Match**

**ข้อมูล:**
- ผู้เสียหาย: "สมชาย ใจดี"
- ชื่อบัญชี: "นาย สมชาย รักษ์ดี ใจดี"

**ผลลัพธ์:**
- ✅ แสดง Tag "ผู้เสียหาย" (คำแรก "สมชาย" + คำสุดท้าย "ใจดี" ตรงกัน)

---

### **Test Case 5: ไม่ตรงกัน**

**ข้อมูล:**
- ผู้เสียหาย: "สมชาย ใจดี"
- ชื่อบัญชี: "สมหญิง รักดี"

**ผลลัพธ์:**
- ❌ ไม่แสดง Tag

---

## 📝 Regex สำหรับลบคำนำหน้า

```javascript
/^(นาย|นาง|นางสาว|น\.ส\.|Mr\.|Mrs\.|Miss|Ms\.)\s*/gi
```

**รองรับ:**
- นาย
- นาง
- นางสาว
- น.ส.
- Mr.
- Mrs.
- Miss
- Ms.

**Flags:**
- `g` - global (ทั้งหมด)
- `i` - case insensitive (ไม่สนใจตัวพิมพ์)

---

## 🎯 Use Cases

### **1. ระบุผู้เสียหายในเส้นทางการเงิน**
```
เห็นได้ทันทีว่าบัญชีไหนเป็นของผู้เสียหาย
→ Tag สีเขียว "ผู้เสียหาย"
```

### **2. วิเคราะห์การไหลของเงิน**
```
เงินไหลจาก: [ผู้เสียหาย] → บัญชีกลาง → ผู้ต้องหา
```

### **3. ตรวจสอบรายการโอนเงินกลับ**
```
ผู้ต้องหา → โอนกลับ → [ผู้เสียหาย]
```

---

## 📁 ไฟล์ที่แก้ไข

### **Frontend:**
- `web-app/frontend/src/pages/DashboardPage.tsx`
  - เพิ่มฟังก์ชัน `isVictimAccount(accountName)`
  - แก้ไข render function ของคอลัมน์ "บัญชีต้นทาง"
  - แก้ไข render function ของคอลัมน์ "บัญชีปลายทาง"
  - เพิ่ม Tag "ผู้เสียหาย" (สีเขียว, ตัวเล็ก)

---

## ⚠️ ข้อควรระวัง

### **False Positives:**
อาจมีบางกรณีที่ตรวจจับผิดพลาด:

**ตัวอย่าง:**
- ผู้เสียหาย: "สมชาย ดี"
- ชื่อบัญชี: "สมหญิง สมชาย ดี มาก"
- → แสดง "ผู้เสียหาย" (เพราะมีคำ "สมชาย" และ "ดี")

**วิธีแก้:**
- ใช้ตัดสินใจร่วมกับข้อมูลอื่น
- ตรวจสอบด้วยตา

---

## 💡 ข้อดี

### **1. ตรวจจับได้ครอบคลุม:**
- ✅ รองรับคำนำหน้าหลากหลาย
- ✅ รองรับช่องว่างต่างกัน
- ✅ รองรับตัวพิมพ์ต่างกัน
- ✅ รองรับชื่อที่มีข้อความเพิ่ม

### **2. แสดงผลชัดเจน:**
- ✅ เห็นได้ทันทีว่าบัญชีไหนเป็นผู้เสียหาย
- ✅ Tag ไม่รบกวนข้อมูล
- ✅ ใช้สีเขียวที่สบายตา

---

## 🎯 ทดสอบ

**Refresh หน้าเว็บ (F5) แล้ว:**

1. คลิก "ดูรายละเอียดคดี"
2. คลิก Tab "ข้อมูล CFR"
3. อัพโหลดไฟล์
4. **ดูตาราง:**
   - ✅ บัญชีต้นทาง/ปลายทางที่ตรงกับผู้เสียหาย → แสดง Tag "ผู้เสียหาย"
   - ✅ Tag สีเขียว ตัวเล็ก
   - ✅ ตารางสวยงาม กระชับ

---

## ✅ สรุป

**ฟีเจอร์ตรวจจับผู้เสียหายพร้อมแล้ว!**

- ✅ ตรวจสอบชื่อแบบละเอียด (6 วิธี)
- ✅ ลบคำนำหน้าอัตโนมัติ
- ✅ แสดง Tag "ผู้เสียหาย" สีเขียว
- ✅ ลบคอลัมน์ Bank Case ID
- ✅ ลดความกว้างคอลัมน์ให้กระชับ
- ✅ ตารางสวยงาม พอดี

**พร้อมทดสอบแล้วครับ!** 🎉

---

**หมายเหตุ:** ยังไม่ได้ commit ขึ้น Git ตามคำสั่ง

