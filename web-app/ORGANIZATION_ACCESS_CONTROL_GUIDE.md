# คู่มือระบบควบคุมสิทธิ์หน่วยงาน

**วันที่:** 11 ตุลาคม 2568

---

## 🎯 ภาพรวมระบบ

ระบบควบคุมสิทธิ์การเข้าใช้งานตามโครงสร้างหน่วยงาน 3 ระดับ:
1. **Bureau (บช.)** - กองบัญชาการ
2. **Division (บก.)** - กองบังคับการ
3. **Supervision (กก.)** - กองกำกับการ

---

## 📊 โครงสร้างหน่วยงาน

### **ระดับที่ 1: Bureau (1 หน่วย)**
- บช.สอท. (กองบัญชาการตำรวจสืบสวนสอบสวนอาชญากรรมทางเทคโนโลยี)

### **ระดับที่ 2: Division (7 หน่วย)**
1. บก.อก.บช.สอท.
2. บก.สอท.1 บช.สอท.
3. บก.สอท.2 บช.สอท.
4. บก.สอท.3 บช.สอท.
5. บก.สอท.4 บช.สอท.
6. บก.สอท.5 บช.สอท.
7. บก.ตอท. บช.สอท.

### **ระดับที่ 3: Supervision (20 หน่วย)**
- แต่ละ บก. มี 4 กก.
- ตัวอย่าง: กก.1-4 บก.สอท.4 บช.สอท.

---

## 🔒 ระบบควบคุมสิทธิ์

### **1. Admin เปิด/ปิดสิทธิ์หน่วยงาน**

**การทำงาน:**
- Admin สามารถเปิด/ปิด `is_active` ของแต่ละหน่วยงานได้
- หน่วยงานที่ `is_active = FALSE` จะไม่สามารถเข้าใช้งานได้

**ผลกระทบ:**

| ระดับ | เมื่อปิดสิทธิ์ | ผลกระทบ |
|-------|---------------|---------|
| **Bureau** | ปิด บช. | ผู้ใช้ทั้งหมดใน บช. นั้นไม่สามารถ Login ได้ |
| **Division** | ปิด บก. | ผู้ใช้ทั้งหมดใน บก. นั้นไม่สามารถ Login ได้ |
| **Supervision** | ปิด กก. | ผู้ใช้ทั้งหมดใน กก. นั้นไม่สามารถ Login ได้ |

### **2. การตรวจสอบสิทธิ์เมื่อ Login**

**ลำดับการตรวจสอบ:**
1. ✅ ตรวจสอบ username/password
2. ✅ ตรวจสอบบัญชีถูกล็อคหรือไม่
3. ✅ ตรวจสอบได้รับการอนุมัติหรือไม่
4. ✅ ตรวจสอบบัญชี active หรือไม่
5. ✅ **ตรวจสอบสิทธิ์หน่วยงาน (ใหม่!)**
   - เช็ค Supervision is_active
   - เช็ค Division is_active
   - เช็ค Bureau is_active

**ถ้าหน่วยงานถูกปิด:**
```
❌ Error 403: ไม่มีสิทธิ์เข้าใช้งาน กรุณาติดต่อผู้ดูแลระบบ
```

### **3. การตรวจสอบระหว่างใช้งาน**

ถ้า Admin ปิดสิทธิ์หน่วยงานขณะที่ User กำลังใช้งานอยู่:
- ✅ API request ถัดไปจะถูก reject
- ✅ User จะถูก logout อัตโนมัติ
- ✅ แสดงข้อความ "ไม่มีสิทธิ์เข้าใช้งาน"

---

## 🎨 หน้าจอจัดการหน่วยงาน

### **URL:**
http://localhost:3001/admin/organizations

### **สิทธิ์:**
- ✅ เฉพาะ Admin เท่านั้น
- ❌ User ทั่วไปเข้าไม่ได้

### **ฟีเจอร์:**

#### **1. สถิติภาพรวม (4 การ์ด)**
- 👥 จำนวนผู้ใช้ทั้งหมด
- ✅ หน่วยงานเปิดใช้งาน (สีเขียว)
- ❌ หน่วยงานปิดใช้งาน (สีแดง)
- 📊 รวมหน่วยงานทั้งหมด

#### **2. โครงสร้างแบบ Hierarchical**
```
บช.สอท. (สีดำ)
├─ บก.สอท.1 [Switch เปิด/ปิด] (4 คน)
│  ├─ กก.1 [Switch] (1 คน)
│  ├─ กก.2 [Switch] (0 คน)
│  ├─ กก.3 [Switch] (0 คน)
│  └─ กก.4 [Switch] (3 คน)
├─ บก.สอท.2 [Switch] (0 คน)
├─ บก.สอท.3 [Switch] (0 คน)
├─ บก.สอท.4 [Switch] (4 คน) ← User ปัจจุบัน
│  ├─ กก.1 [Switch] (4 คน) ← ทุกคนอยู่ที่นี่
│  ├─ กก.2 [Switch] (0 คน)
│  ├─ กก.3 [Switch] (0 คน)
│  └─ กก.4 [Switch] (0 คน)
└─ บก.สอท.5 [Switch] (0 คน)
```

#### **3. การควบคุม**
- **Switch ระดับ บก.:** ปิดทั้ง บก. และ กก. ทั้งหมดใต้ บก. นั้น
- **Switch ระดับ กก.:** ปิดเฉพาะ กก. นั้น

---

## 🧪 การทดสอบ

### **Test Case 1: ปิดสิทธิ์ กก.1 บก.สอท.4**

**ขั้นตอน:**
1. Admin เข้าหน้า "จัดการหน่วยงาน"
2. ขยาย "บก.สอท.4"
3. ปิด Switch ของ "กก.1 บก.สอท.4 บช.สอท."
4. User (admin, nuicpe32, bank123, testuser) พยายาม Login

**ผลลัพธ์:**
```
❌ ไม่มีสิทธิ์เข้าใช้งาน กรุณาติดต่อผู้ดูแลระบบ
```

### **Test Case 2: ปิดสิทธิ์ บก.สอท.4**

**ขั้นตอน:**
1. Admin ปิด Switch ของ "บก.สอท.4"
2. ทุกคนใน บก.สอท.4 (รวม กก. ทั้ง 4) พยายาม Login

**ผลลัพธ์:**
```
❌ ไม่มีสิทธิ์เข้าใช้งาน กรุณาติดต่อผู้ดูแลระบบ
```

### **Test Case 3: User กำลังใช้งานอยู่**

**ขั้นตอน:**
1. User Login และใช้งานอยู่
2. Admin ปิดสิทธิ์หน่วยงานของ User
3. User คลิกเมนูหรือทำอะไรต่อ

**ผลลัพธ์:**
- ✅ API จะ return 403 Forbidden
- ✅ Frontend จะ logout User อัตโนมัติ
- ✅ Redirect ไป Login page
- ✅ แสดงข้อความ "ไม่มีสิทธิ์เข้าใช้งาน"

---

## 📝 Database Schema

### **ตาราง bureaus:**
```sql
id | name_full | name_short | is_active
```

### **ตาราง divisions:**
```sql
id | bureau_id (FK) | name_full | name_short | is_active
```

### **ตาราง supervisions:**
```sql
id | division_id (FK) | name_full | name_short | is_active
```

### **ตาราง users (เพิ่มฟิลด์):**
```sql
bureau_id (FK, NOT NULL)
division_id (FK, NOT NULL)
supervision_id (FK, NOT NULL)
```

---

## 🔧 การใช้งาน

### **สำหรับ Admin:**

1. **เข้าหน้าจัดการ:**
   - เมนู: "ระบบผู้ดูแล" → "จัดการหน่วยงาน"
   - URL: http://localhost:3001/admin/organizations

2. **เปิด/ปิดสิทธิ์:**
   - คลิก Switch ข้างหน่วยงาน
   - ระบบจะอัพเดตทันที

3. **ดูสถิติ:**
   - จำนวนผู้ใช้แต่ละหน่วย
   - หน่วยงานที่เปิด/ปิด

### **สำหรับ User:**

- ถ้าหน่วยงานถูกปิด → **ไม่สามารถ Login ได้**
- แสดงข้อความ: "ไม่มีสิทธิ์เข้าใช้งาน กรุณาติดต่อผู้ดูแลระบบ"

---

## ⚠️ ข้อควรระวัง

1. **อย่าปิดหน่วยงานของตัวเอง!**
   - ถ้า Admin ปิดหน่วยงานตัวเอง จะไม่สามารถ Login กลับเข้ามาได้
   - ต้องให้ Admin คนอื่นเปิดให้

2. **ผู้ใช้ที่กำลังใช้งานอยู่:**
   - จะถูก logout ทันทีเมื่อทำ request ครั้งถัดไป
   - ไม่ได้ logout ทันที แต่จะ logout เมื่อมี API call

3. **การเปิดสิทธิ์กลับ:**
   - เปิด Switch กลับ → User สามารถ Login ได้ทันที

---

## 🎉 สรุป

✅ **ระบบควบคุมสิทธิ์หน่วยงานพร้อมแล้ว!**

- Admin สามารถเปิด/ปิดสิทธิ์หน่วยงานได้
- User ที่หน่วยงานถูกปิดจะ Login ไม่ได้
- แสดงข้อความ "ไม่มีสิทธิ์เข้าใช้งาน กรุณาติดต่อผู้ดูแลระบบ"
- ป้องกันการเข้าถึงทั้งตอน Login และระหว่างใช้งาน

**พร้อมใช้งานแล้ว!** 🚀

---

**หมายเหตุ:** ยังไม่ได้ commit ขึ้น Git ตามคำสั่ง

