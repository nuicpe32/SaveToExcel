# 📋 Release Notes - CFR Auto Summons Creation v3.3.1

**Release Date:** October 11, 2025  
**Version:** 3.3.1  
**Commit:** bd3e229

---

## 🎯 สรุปการอัพเดต

เพิ่มฟีเจอร์สร้างหมายเรียกอัตโนมัติจากตาราง CFR เพื่อเพิ่มความสะดวกในการออกหมายเรียกบัญชีธนาคาร โดยระบบจะกรอกข้อมูลทั้งหมดให้อัตโนมัติจากข้อมูล CFR

---

## ✨ ฟีเจอร์ใหม่

### 1. 🆕 ปุ่ม "สร้างหมายเรียก" ในตาราง CFR
- **แสดงเฉพาะบัญชีที่ยังไม่เคยทำหมายเรียก**
- **ไม่แสดงสำหรับบัญชีผู้เสียหาย**
- **ปุ่มเล็กๆ สีน้ำเงินใต้ข้อมูลบัญชี**

### 2. 📝 กรอกข้อมูลอัตโนมัติ
เมื่อคลิกปุ่ม "สร้างหมายเรียก" ระบบจะกรอกข้อมูลให้อัตโนมัติ:
- ✅ **ธนาคาร** - แปลงจาก bank_short_name เป็นชื่อธนาคารเต็ม
- ✅ **เลขที่บัญชี** - ดึงจาก to_account_no
- ✅ **ชื่อบัญชี** - ดึงจาก to_account_name
- ✅ **ลงวันที่** - ตั้งเป็นวันปัจจุบันอัตโนมัติ
- ✅ **กำหนดส่ง** - คำนวณเป็น วันนี้ + 14 วัน
- ✅ **ช่วงเวลาที่ทำธุรกรรม** - คำนวณเป็น 1 วันก่อน - 1 วันหลัง

### 3. 📊 แสดงจำนวนบน Tab
เพิ่มตัวเลขแสดงจำนวนบน Tab เพื่อง่ายต่อการมองเห็น:
- ✅ **บัญชีธนาคารที่เกี่ยวข้อง (X)**
- ✅ **ผู้ต้องหาที่เกี่ยวข้อง (Y)**
- ✅ **ข้อมูล CFR (Z)**

### 4. 🔴 ข้อความแจ้งเตือนสำหรับข้อมูลจาก CFR
เมื่อสร้างหมายเรียกจาก CFR:
- **ข้อความสีแดง + ตัวหนา**: "จะบันทึกเป็น: 1 ก.ค. 68 - 3 ก.ค. 68 **(ตามข้อมูลจาก CFR)**"
- User จะเห็นชัดเจนว่าไม่ต้องเลือกช่วงเวลาใหม่

---

## 🔧 การแก้ไข

### 1. ✅ แก้ไขการคำนวณปี พ.ศ.
**ปัญหาเดิม:**
- CFR มีวันที่เป็นปี พ.ศ. (2568-07-02)
- ระบบบวก 543 อีกที → ได้ 3111 → แสดงเป็น "11" (ผิด!)

**แก้ไข:**
- ตรวจสอบว่าปีมากกว่า 2500 หรือไม่
- ถ้าใช่ → แปลงเป็น ค.ศ. ก่อน (ลบ 543)
- คำนวณช่วงเวลา
- แปลงกลับเป็น พ.ศ. ไทย (บวก 543)
- ผลลัพธ์: "1 ก.ค. 68 - 3 ก.ค. 68" ✅

### 2. ✅ เพิ่มรหัสธนาคาร KBNK
เพิ่ม KBNK (ธนาคารกสิกรไทย) ใน bank mapping:
```javascript
'KBNK': 'ธนาคารกสิกรไทย'
```

### 3. 🗑️ ลบปุ่มบันทึกรูปภาพออกจากแผนผัง CFR
- ลบปุ่ม "บันทึกเป็นรูปภาพ" ชั่วคราว
- รอแก้ไขปัญหาการ capture รูปภาพ (ภาพขาว/เส้นหาย)

---

## 🏦 Bank Code Mapping

ธนาคารที่รองรับใน CFR Auto Summons:
- BBL → ธนาคารกรุงเทพ
- KBANK → ธนาคารกสิกรไทย
- **KBNK → ธนาคารกสิกรไทย** (ใหม่!)
- KTB → ธนาคารกรุงไทย
- TTB → ธนาคารทหารไทยธนชาต
- SCB → ธนาคารไทยพาณิชย์
- BAY → ธนาคารกรุงศรีอยุธยา
- CIMBT → ธนาคารซีไอเอ็มบี ไทย
- UOBT → ธนาคารยูโอบี
- KKP → ธนาคารเกียรตินาคินภัทร
- GSB → ธนาคารออมสิน
- GHB → ธนาคารอาคารสงเคราะห์
- BAAC → ธนาคารเพื่อการเกษตรและสหกรณ์การเกษตร
- LH → ธนาคารแลนด์ แอนด์ เฮ้าส์

---

## 📝 การใช้งาน

### สร้างหมายเรียกจาก CFR
1. **เปิดรายละเอียดคดี**
2. **ไปที่แท็บ "ข้อมูล CFR"**
3. **หาบัญชีที่ยังไม่เคยทำหมายเรียก** (ไม่มีป้าย "ส่งหมายเรียกแล้ว")
4. **กดปุ่ม "สร้างหมายเรียก"** ใต้ข้อมูลบัญชี
5. **ตรวจสอบข้อมูลที่กรอกอัตโนมัติ**
6. **กดบันทึก**

### ข้อมูลที่ระบบกรอกให้
- ✅ ธนาคาร
- ✅ เลขบัญชี
- ✅ ชื่อบัญชี
- ✅ ลงวันที่ (วันนี้)
- ✅ กำหนดส่ง (วันนี้ + 14 วัน)
- ✅ ช่วงเวลาทำธุรกรรม (1 วันก่อน - 1 วันหลัง)

---

## 🔄 การเปลี่ยนแปลงโค้ด

### Frontend
**ไฟล์ที่แก้ไข:**
- `web-app/frontend/src/pages/DashboardPage.tsx`
  - เพิ่มฟังก์ชัน `handleCreateSummonsFromCfr()`
  - เพิ่มการตรวจสอบปี พ.ศ./ค.ศ.
  - เพิ่ม bank mapping (KBNK)
  - เพิ่มตัวเลขบน Tab

- `web-app/frontend/src/components/BankAccountFormModal.tsx`
  - เพิ่มการรองรับ `_is_new_from_cfr` flag
  - เพิ่มข้อความสีแดง "(ตามข้อมูลจาก CFR)"
  - เพิ่มการ populate date range จาก CFR

- `web-app/frontend/src/components/CfrFlowChart.tsx`
  - ลบปุ่มบันทึกรูปภาพ
  - ลบ functions ที่ไม่ใช้

**ไฟล์ที่เพิ่มใหม่:**
- `web-app/CFR_FLOW_CHART_FEATURE.md`
- `web-app/CFR_FLOW_CHART_V2_IMPROVEMENTS.md`
- `web-app/RELEASE_NOTES_CFR_v3.3.0.md`

---

## 🐛 Known Issues

### แผนผัง CFR
- ปุ่มบันทึกรูปภาพถูกลบออกชั่วคราว
- ปัญหา: รูปที่บันทึกออกมาขาว/เส้นหาย
- สถานะ: รอแก้ไข

---

## 📊 Statistics

**Files Changed:** 8 files  
**Insertions:** +2,267 lines  
**Deletions:** -15 lines  

---

## 🔗 Related Documents

- [CFR Flow Chart Feature](./CFR_FLOW_CHART_FEATURE.md)
- [CFR Flow Chart V2 Improvements](./CFR_FLOW_CHART_V2_IMPROVEMENTS.md)
- [Release Notes CFR v3.3.0](./RELEASE_NOTES_CFR_v3.3.0.md)

---

## ✅ Testing Checklist

- [x] สร้างหมายเรียกจาก CFR ได้
- [x] ข้อมูลกรอกอัตโนมัติถูกต้อง
- [x] ปี พ.ศ. คำนวณถูกต้อง (68 ไม่ใช่ 11)
- [x] KBNK แปลงเป็นธนาคารกสิกรไทยได้
- [x] แสดงจำนวนบน Tab ถูกต้อง
- [x] ข้อความสีแดงแสดงเมื่อมาจาก CFR
- [x] บันทึกและปริ้นหมายเรียกได้
- [x] Refresh ข้อมูลหลังบันทึกสำเร็จ

---

## 👨‍💻 Developer Notes

### Bank Code Mapping
เมื่อเพิ่มธนาคารใหม่ใน CFR ให้เพิ่มใน `bankMapping` ที่:
```typescript
// web-app/frontend/src/pages/DashboardPage.tsx
const bankMapping: { [key: string]: string } = {
  'BANK_CODE': 'ชื่อธนาคารเต็ม',
  // ...
}
```

### Date Range Calculation
```typescript
// แปลง พ.ศ. เป็น ค.ศ. ถ้า year > 2500
if (year > 2500) {
  const adYear = year - 543
  transferDateStr = transferDateStr.replace(year.toString(), adYear.toString())
}

// คำนวณ 1 วันก่อน - 1 วันหลัง
const startDate = transferDate.subtract(1, 'day')
const endDate = transferDate.add(1, 'day')
```

---

## 🙏 Acknowledgments

**Developed by:** CCIB Development Team  
**Tested by:** User Acceptance Testing  
**Approved by:** Project Manager

---

**🎉 Happy Coding!**

